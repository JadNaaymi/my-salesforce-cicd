name: Professional Salesforce CI
on: [push]

jobs:
  validate-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Authenticate to Dev Hub
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth_url.txt
          sf org login sfdx-url --sfdx-url-file auth_url.txt --set-default-dev-hub

      - name: Create Scratch Org
        run: sf org create scratch --definition-file config/project-scratch-def.json --alias temp-org --wait 10 --set-default

      - name: Deploy Code
        run: sf project deploy start --target-org temp-org

      # PROFESSIONAL GATE: Run Tests
      - name: Run Apex Tests
        run: sf apex run test --target-org temp-org --wait 10 --result-format human --code-coverage

      # PROFESSIONAL CLEANUP: This runs even if tests fail
      - name: Delete Scratch Org
        if: always() 
        run: sf org delete scratch --target-org temp-org --no-prompt